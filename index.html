<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>石头剪刀布 - 街机版</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --glow-yellow: #ffee00;
      --glow-cyan: #00ffff;
      --glow-magenta: #ff00ff;
      --glow-red: #ff0000;
      --glow-green: #00ff00;
      --border-color: var(--glow-cyan);
      --bg-color: #000000;
      --text-color: var(--glow-cyan);
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
    @keyframes bounce-in {
      0% { transform: translateY(-100px); opacity: 0; }
      60% { transform: translateY(10px); opacity: 1; }
      100% { transform: translateY(0); }
    }

    html {
      font-size: 16px; /* Establish a base font size */
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      background-image: 
        linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 30px 30px;
    }

    h1 {
      color: var(--glow-yellow);
      text-shadow: 0 0 5px var(--glow-yellow), 0 0 10px var(--glow-yellow);
      animation: blink 2s infinite;
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-align: center;
    }
    h2 {
      color: var(--glow-magenta);
      text-shadow: 0 0 3px var(--glow-magenta);
      font-size: 1.5rem;
      text-align: center;
    }

    .pixel-border {
      border: 4px solid var(--border-color);
      box-shadow: 
        inset 0 0 0 4px var(--bg-color),
        0 0 0 4px var(--border-color),
        inset 0 0 10px var(--border-color),
        0 0 10px var(--border-color);
      padding: 20px;
    }

    #game-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 30px;
    }

    #left-panel { flex: 3; display: flex; flex-direction: column; align-items: center; min-width: 0; }
    #right-panel { flex: 2; display: flex; flex-direction: column; align-items: center; min-width: 0; }
    
    video { max-width: 100%; height: auto; }
    canvas { display: none; }

    #controls button {
      font-family: 'Press Start 2P', cursive;
      font-size: 1rem;
      color: var(--bg-color);
      border: 4px solid #000;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      position: relative;
      box-shadow: inset -4px -4px 0px 0px #fff, -4px -4px 0px 0px #000;
      transition: all 0.1s ease-in-out;
    }
    #controls button:hover { animation: shake 0.2s infinite; }
    #controls button:active {
      top: 4px;
      left: 4px;
      box-shadow: inset 0 0 0 0 #fff, 0 0 0 0 #000;
    }
    #playButton { background-color: var(--glow-cyan); }
    #resetButton { background-color: var(--glow-red); display: none; }
    #playButton:disabled { background-color: #555; color: #999; animation: none; box-shadow: inset -4px -4px 0px 0px #777, -4px -4px 0px 0px #000; }

    #status { font-size: 1rem; margin-top: 15px; min-height: 30px; color: var(--glow-yellow); text-align: center; }
    #scoreboard { font-size: 1.8rem; font-weight: bold; margin: 15px 0; text-align: center; }
    
    .history-log { display: flex; flex-direction: column; gap: 15px; width: 100%; }
    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-around;
      width: 95%;
      padding: 10px;
    }
    .history-item .player-info { text-align: center; }
    .history-item p { margin: 5px 0; font-size: 0.8rem; }
    .history-item .result { font-size: 2rem; margin: 0 15px; }
    .history-item img { width: 80px; height: 60px; object-fit: cover; border: 2px solid var(--glow-magenta); }
    .history-item .history-emoji { font-size: 3.5rem; line-height: 1; height: 60px; display: flex; align-items: center; justify-content: center; }
    .history-item .timing { font-size: 0.6rem; color: #aaa; margin-top: 4px; }

    #match-result {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 20px;
      min-height: 35px;
      text-align: center;
      animation: bounce-in 0.5s;
    }
    .win { color: var(--glow-green); text-shadow: 0 0 5px var(--glow-green); }
    .lose { color: var(--glow-red); text-shadow: 0 0 5px var(--glow-red); }
    .draw { color: var(--glow-yellow); text-shadow: 0 0 5px var(--glow-yellow); }

    #avg-timing { font-size: 0.8rem; margin-top: 10px; text-align: center; }

    /* --- Responsive Design --- */
    @media (max-width: 1024px) {
      h1 { font-size: 2rem; }
      #game-container {
        flex-direction: column;
      }
      #right-panel {
        border-left: none;
        padding-left: 0;
        margin-top: 30px;
        border-top: 4px solid var(--border-color);
        padding-top: 30px;
      }
      #scoreboard { font-size: 1.5rem; }
      #match-result { font-size: 1.2rem; }
    }

    @media (max-width: 480px) {
      body { padding: 10px; }
      h1 { font-size: 1.5rem; }
      .pixel-border { padding: 10px; }
      .history-item { flex-direction: column; gap: 10px; }
    }

  </style>
</head>
<body>
  <h1>ROCK PAPER SCISSORS</h1>
  <div id="game-container" class="pixel-border">
    <div id="left-panel">
      <video id="video" autoplay muted class="pixel-border"></video>
      <canvas id="canvas"></canvas>
      <div id="scoreboard">YOU 0 - 0 AI</div>
      <div id="status">PRESS START</div>
      <div id="match-result"></div>
      <div id="avg-timing"></div>
      <div id="controls">
        <button id="playButton" onclick="playGame()" disabled>PLAY</button>
        <button id="resetButton" onclick="resetMatch()">AGAIN</button>
      </div>
    </div>
    <div id="right-panel">
      <div id="history">
        <h2>HISTORY</h2>
        <div class="history-log" id="historyLog"></div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDiv = document.getElementById('status');
    const playButton = document.getElementById('playButton');
    const resetButton = document.getElementById('resetButton');
    const scoreboardDiv = document.getElementById('scoreboard');
    const historyLogDiv = document.getElementById('historyLog');
    const matchResultDiv = document.getElementById('match-result');
    const avgTimingDiv = document.getElementById('avg-timing');

    let videoStream = null;
    let playerMatchScore = 0;
    let aiMatchScore = 0;
    let roundCount = 0;
    const maxRounds = 5;
    const winScore = 3;
    let userGestureTimes = [];
    let aiGestureTimes = [];

    const aiGestureEmojis = {
      '石头': '✊',
      '剪刀': '✌️',
      '布': '✋'
    };

    window.addEventListener('load', () => {
      setupUser();
      setupCamera();
    });
    window.addEventListener('beforeunload', () => {
      if (videoStream) videoStream.getTracks().forEach(track => track.stop());
    });

    function setupUser() {
      let userId = localStorage.getItem('rpsUserId');
      if (!userId) {
        userId = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('rpsUserId', userId);
      }
    }

    function setupCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            playButton.disabled = false;
            statusDiv.textContent = 'READY PLAYER ONE';
          };
        })
        .catch(err => {
          console.error('CAMERA ERROR:', err);
          statusDiv.textContent = 'NO CAMERA DETECTED';
          playButton.disabled = true;
        });
    }

    async function resizeAndEncode(canvas, maxWidth, maxHeight, quality) {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let width = canvas.width, height = canvas.height;
        if (width > maxWidth || height > maxHeight) {
            if (width / height > maxWidth / maxHeight) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            } else {
                width = Math.round(width * (maxHeight / height));
                height = maxHeight;
            }
        }
        const resizeCanvas = document.createElement('canvas');
        resizeCanvas.width = width;
        resizeCanvas.height = height;
        resizeCanvas.getContext('2d').drawImage(canvas, 0, 0, width, height);
        return resizeCanvas.toDataURL('image/jpeg', quality);
    }

    async function playGame() {
      if (isMatchOver()) return;
      statusDiv.textContent = 'SCANNING...';
      playButton.disabled = true;
      try {
        const imageData = await resizeAndEncode(canvas, 512, 512, 0.85);
        const base64Image = imageData.split(',')[1];
        const response = await fetch('https://rpsbackend.lucyfer81.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Image })
        });
        const data = await response.json();
        if (response.status !== 200 || data.error) {
          statusDiv.textContent = `ERROR: ${data.error || 'UNKNOWN'}`;
          playButton.disabled = false;
          return;
        }
        roundCount++;
        updateScore(data.result);
        userGestureTimes.push(data.userGestureTime);
        aiGestureTimes.push(data.aiGestureTime);
        updateHistory(imageData, data);
        checkMatchWinner();
      } catch (err) {
        console.error('REQUEST ERROR:', err);
        statusDiv.textContent = 'REQUEST FAILED';
      } finally {
        if (!isMatchOver()) playButton.disabled = false;
      }
    }

    function updateScore(result) {
      if (result === '你赢了') playerMatchScore++;
      else if (result === 'AI赢了') aiMatchScore++;
      scoreboardDiv.textContent = `YOU ${playerMatchScore} - ${aiMatchScore} AI`;
    }

    function updateHistory(userImgData, data) {
      const { userGesture, aiGesture, result, userGestureTime, aiGestureTime } = data;
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item pixel-border';
      const resultText = result === '平局' ? 'DRAW' : (result === '你赢了' ? 'WIN' : 'LOSE');
      historyItem.innerHTML = `
        <div class="player-info">
          <p>YOU (${userGesture})</p>
          <img src="${userImgData}" alt="Your move">
          <div class="timing">Scan: ${userGestureTime}ms</div>
        </div>
        <div class="result">${resultText}</div>
        <div class="player-info">
          <p>AI (${aiGesture})</p>
          <div class="history-emoji">${aiGestureEmojis[aiGesture]}</div>
          <div class="timing">AI: ${aiGestureTime}ms</div>
        </div>
      `;
      if (historyLogDiv.children.length >= maxRounds) {
        historyLogDiv.removeChild(historyLogDiv.lastChild);
      }
      historyLogDiv.insertBefore(historyItem, historyLogDiv.firstChild);
    }
    
    function isMatchOver() {
        return roundCount >= maxRounds || playerMatchScore >= winScore || aiMatchScore >= winScore;
    }

    function checkMatchWinner() {
      if (isMatchOver()) {
        let finalMessage = '';
        let finalClass = '';
        if (playerMatchScore > aiMatchScore) {
          finalMessage = 'YOU WIN!';
          finalClass = 'win';
        } else if (aiMatchScore > playerMatchScore) {
          finalMessage = 'YOU LOSE!';
          finalClass = 'lose';
        } else {
          finalMessage = 'DRAW GAME!';
          finalClass = 'draw';
        }
        matchResultDiv.textContent = finalMessage;
        matchResultDiv.className = finalClass;
        calculateAndShowAverageTimes();
        statusDiv.textContent = 'GAME OVER';
        playButton.style.display = 'none';
        resetButton.style.display = 'inline-block';
        playButton.disabled = true;
      } else {
        statusDiv.textContent = `ROUND ${roundCount + 1} - FIGHT!`;
      }
    }

    function calculateAndShowAverageTimes() {
        if(userGestureTimes.length === 0) return;
        const avgUserTime = userGestureTimes.reduce((a, b) => a + b, 0) / userGestureTimes.length;
        const avgAiTime = aiGestureTimes.reduce((a, b) => a + b, 0) / aiGestureTimes.length;
        avgTimingDiv.textContent = `AVG SCAN: ${Math.round(avgUserTime)}ms | AVG AI: ${Math.round(avgAiTime)}ms`;
    }

    function resetMatch() {
      playerMatchScore = 0;
      aiMatchScore = 0;
      roundCount = 0;
      userGestureTimes = [];
      aiGestureTimes = [];
      scoreboardDiv.textContent = 'YOU 0 - 0 AI';
      historyLogDiv.innerHTML = '';
      matchResultDiv.textContent = '';
      matchResultDiv.className = '';
      avgTimingDiv.textContent = '';
      statusDiv.textContent = 'READY PLAYER ONE';
      playButton.style.display = 'inline-block';
      resetButton.style.display = 'none';
      playButton.disabled = false;
    }
  </script>
</body>
</html>
