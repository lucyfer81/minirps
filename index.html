<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>çŸ³å¤´å‰ªåˆ€å¸ƒæ¸¸æˆ (äº”å±€ä¸‰èƒœ)</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    
    #game-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 30px;
    }

    #left-panel {
      flex: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #right-panel {
      flex: 2;
      border-left: 2px solid #f0f0f0;
      padding-left: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    video { border: 2px solid #333; border-radius: 8px; max-width: 100%; height: auto;}
    canvas { display: none; }

    #controls button { padding: 12px 25px; font-size: 18px; cursor: pointer; color: white; border: none; border-radius: 5px; margin: 5px; transition: background-color 0.3s; }
    #playButton { background-color: #4CAF50; }
    #playButton:hover { background-color: #45a049; }
    #playButton:disabled { background-color: #cccccc; cursor: not-allowed; }
    #resetButton { background-color: #f44336; display: none; }
    #resetButton:hover { background-color: #da190b; }

    #status { font-size: 20px; margin-top: 15px; color: #555; min-height: 30px; }
    #scoreboard { font-size: 28px; font-weight: bold; margin: 15px 0; color: #2c3e50; }
    
    #history h2 { text-align: center; margin-bottom: 15px; }
    .history-log { 
      display: flex; 
      flex-direction: column; 
      gap: 15px; 
      width: 100%;
    }
    .history-item { 
      background-color: #f9f9f9; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-around;
      width: 95%;
    }
    .history-item .player-info { text-align: center; }
    .history-item p { margin: 5px 0; font-size: 14px; font-weight: bold; }
    .history-item .result { font-size: 24px; margin: 0 15px; }
    .history-item img { width: 80px; height: 60px; border-radius: 5px; object-fit: cover; border: 1px solid #ccc; }
    .history-item .timing { font-size: 11px; color: #888; margin-top: 4px; }

    #match-result { font-size: 22px; font-weight: bold; margin-top: 20px; color: #e67e22; min-height: 35px; text-align: center; }
    #avg-timing { font-size: 16px; color: #555; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>
  <h1>çŸ³å¤´å‰ªåˆ€å¸ƒ - äº”å±€ä¸‰èƒœ</h1>
  <div id="game-container">
    <!-- Left Panel -->
    <div id="left-panel">
      <video id="video" width="480" height="360" autoplay muted></video>
      <canvas id="canvas" width="480" height="360"></canvas>
      <div id="scoreboard">ä½  0 - 0 AI</div>
      <div id="status">è¯·å…è®¸æ‘„åƒå¤´è®¿é—®æƒé™...</div>
      <div id="match-result"></div>
      <div id="avg-timing"></div>
      <div id="controls">
        <button id="playButton" onclick="playGame()" disabled>å‡ºæ‹³</button>
        <button id="resetButton" onclick="resetMatch()">å†ç©ä¸€å±€</button>
      </div>
    </div>

    <!-- Right Panel -->
    <div id="right-panel">
      <div id="history">
        <h2>æœ€è¿‘å¯¹å±€</h2>
        <div class="history-log" id="historyLog"></div>
      </div>
    </div>
  </div>

  <script>
    // DOM å…ƒç´ 
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDiv = document.getElementById('status');
    const playButton = document.getElementById('playButton');
    const resetButton = document.getElementById('resetButton');
    const scoreboardDiv = document.getElementById('scoreboard');
    const historyLogDiv = document.getElementById('historyLog');
    const matchResultDiv = document.getElementById('match-result');
    const avgTimingDiv = document.getElementById('avg-timing');

    // æ¸¸æˆçŠ¶æ€å˜é‡
    let videoStream = null;
    let playerMatchScore = 0;
    let aiMatchScore = 0;
    let roundCount = 0;
    const maxRounds = 5;
    const winScore = 3;
    let userGestureTimes = [];
    let aiGestureTimes = [];

    // AI å‡ºæ‹³å›¾ç‰‡ (å¯æ›¿æ¢ä¸ºæœ¬åœ°è·¯å¾„)
    const aiGestureImages = {
      'çŸ³å¤´': 'https://user-images.githubusercontent.com/11156953/205533033-6e32c0b5-3748-475c-8263-9e9c3a7e5181.png',
      'å‰ªåˆ€': 'https://user-images.githubusercontent.com/11156953/205533036-12d1a01b-6c74-4d6a-86e6-353ab1d63549.png',
      'å¸ƒ': 'https://user-images.githubusercontent.com/11156953/205533035-a35f32e1-4e80-4063-8663-4f9d6425191c.png'
    };

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      setupUser();
      setupCamera();
    });

    window.addEventListener('beforeunload', () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
    });

    // ç”¨æˆ·è¯†åˆ«
    function setupUser() {
      let userId = localStorage.getItem('rpsUserId');
      if (!userId) {
        userId = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('rpsUserId', userId);
        console.log('æ–°ç”¨æˆ·IDå·²åˆ›å»º:', userId);
      } else {
        console.log('æ¬¢è¿å›æ¥, ç”¨æˆ·ID:', userId);
      }
    }

    // è®¾ç½®æ‘„åƒå¤´
    function setupCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          videoStream = stream;
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            playButton.disabled = false;
            statusDiv.textContent = 'å‡†å¤‡å°±ç»ªï¼Œè¯·å‡ºæ‹³ï¼';
          };
        })
        .catch(err => {
          console.error('æ‘„åƒå¤´é”™è¯¯:', err);
          statusDiv.textContent = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚';
          playButton.disabled = true;
        });
    }

    // è°ƒæ•´å›¾åƒå¤§å°ã€å‹ç¼©å¹¶ç¼–ç 
    async function resizeAndEncode(canvas, maxWidth, maxHeight, quality) {
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let width = canvas.width;
        let height = canvas.height;

        if (width > maxWidth || height > maxHeight) {
            if (width / height > maxWidth / maxHeight) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            } else {
                width = Math.round(width * (maxHeight / height));
                height = maxHeight;
            }
        }

        const resizeCanvas = document.createElement('canvas');
        resizeCanvas.width = width;
        resizeCanvas.height = height;
        resizeCanvas.getContext('2d').drawImage(canvas, 0, 0, width, height);
        return resizeCanvas.toDataURL('image/jpeg', quality);
    }

    // æ ¸å¿ƒæ¸¸æˆæµç¨‹
    async function playGame() {
      if (isMatchOver()) {
        statusDiv.textContent = 'æœ¬è½®æ¯”èµ›å·²ç»“æŸã€‚';
        return;
      }

      statusDiv.textContent = 'æ­£åœ¨è¯†åˆ«...';
      playButton.disabled = true;

      try {
        const imageData = await resizeAndEncode(canvas, 512, 512, 0.85);
        const base64Image = imageData.split(',')[1];

        const response = await fetch('https://rpsbackend.lucyfer81.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: base64Image })
        });
        
        const data = await response.json();

        if (response.status !== 200 || data.error) {
          statusDiv.textContent = `é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
          playButton.disabled = false;
          return;
        }
        
        roundCount++;
        updateScore(data.result);
        
        userGestureTimes.push(data.userGestureTime);
        aiGestureTimes.push(data.aiGestureTime);

        updateHistory(imageData, data);
        checkMatchWinner();

      } catch (err) {
        console.error('è¯·æ±‚é”™è¯¯:', err);
        statusDiv.textContent = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
      } finally {
        if (!isMatchOver()) {
          playButton.disabled = false;
        }
      }
    }

    // æ›´æ–°åˆ†æ•°
    function updateScore(result) {
      if (result === 'ä½ èµ¢äº†') {
        playerMatchScore++;
      } else if (result === 'AIèµ¢äº†') {
        aiMatchScore++;
      }
      scoreboardDiv.textContent = `ä½  ${playerMatchScore} - ${aiMatchScore} AI`;
    }

    // æ›´æ–°å†å²è®°å½•
    function updateHistory(userImgData, data) {
      const { userGesture, aiGesture, result, userGestureTime, aiGestureTime } = data;
      const historyItem = document.createElement('div');
      historyItem.className = 'history-item';

      const resultText = result === 'å¹³å±€' ? 'ğŸ¤' : (result === 'ä½ èµ¢äº†' ? 'ğŸ†' : 'ğŸ¤–');

      historyItem.innerHTML = `
        <div class="player-info">
          <p>ä½  (${userGesture})</p>
          <img src="${userImgData}" alt="ä½ çš„å‡ºæ‹³">
          <div class="timing">è¯†åˆ«: ${userGestureTime}ms</div>
        </div>
        <div class="result">${resultText}</div>
        <div class="player-info">
          <p>AI (${aiGesture})</p>
          <img src="${aiGestureImages[aiGesture]}" alt="AIçš„å‡ºæ‹³">
          <div class="timing">AI: ${aiGestureTime}ms</div>
        </div>
      `;
      
      if (historyLogDiv.children.length >= maxRounds) {
        historyLogDiv.removeChild(historyLogDiv.firstChild);
      }
      historyLogDiv.insertBefore(historyItem, historyLogDiv.firstChild);
    }
    
    function isMatchOver() {
        return roundCount >= maxRounds || playerMatchScore >= winScore || aiMatchScore >= winScore;
    }

    // æ£€æŸ¥å¹¶å®£å¸ƒæœ€ç»ˆèƒœåˆ©è€…
    function checkMatchWinner() {
      if (isMatchOver()) {
        let finalMessage = '';
        if (playerMatchScore > aiMatchScore) {
          finalMessage = 'ğŸ‰ æ­å–œä½ ï¼Œè·å¾—äº†æœ€ç»ˆçš„èƒœåˆ©ï¼ ğŸ‰';
          matchResultDiv.style.color = '#2ecc71';
        } else if (aiMatchScore > playerMatchScore) {
          finalMessage = 'ğŸ¤– å¾ˆé—æ†¾ï¼ŒAIèµ¢å¾—äº†æœ¬åœºæ¯”èµ›ã€‚ ğŸ¤–';
          matchResultDiv.style.color = '#e74c3c';
        } else {
          finalMessage = 'ğŸ¤ åŠ¿å‡åŠ›æ•Œï¼Œæœ¬åœºæ¯”èµ›å¹³å±€ï¼ ğŸ¤';
          matchResultDiv.style.color = '#f39c12';
        }
        matchResultDiv.textContent = finalMessage;
        calculateAndShowAverageTimes();
        statusDiv.textContent = 'æ¯”èµ›ç»“æŸï¼';
        playButton.style.display = 'none';
        resetButton.style.display = 'inline-block';
        playButton.disabled = true;
      } else {
        statusDiv.textContent = `ç¬¬ ${roundCount + 1} å±€ï¼Œè¯·å‡ºæ‹³ï¼`;
      }
    }

    // è®¡ç®—å¹¶æ˜¾ç¤ºå¹³å‡æ—¶é—´
    function calculateAndShowAverageTimes() {
        if(userGestureTimes.length === 0) return;
        const avgUserTime = userGestureTimes.reduce((a, b) => a + b, 0) / userGestureTimes.length;
        const avgAiTime = aiGestureTimes.reduce((a, b) => a + b, 0) / aiGestureTimes.length;
        avgTimingDiv.textContent = `å¹³å‡è¯†åˆ«è€—æ—¶: ${Math.round(avgUserTime)}ms | å¹³å‡AIå‡ºæ‹³è€—æ—¶: ${Math.round(avgAiTime)}ms`;
    }

    // é‡ç½®æ¯”èµ›
    function resetMatch() {
      playerMatchScore = 0;
      aiMatchScore = 0;
      roundCount = 0;
      userGestureTimes = [];
      aiGestureTimes = [];
      
      scoreboardDiv.textContent = 'ä½  0 - 0 AI';
      historyLogDiv.innerHTML = '';
      matchResultDiv.textContent = '';
      avgTimingDiv.textContent = '';
      statusDiv.textContent = 'æ–°æ¯”èµ›å¼€å§‹ï¼Œè¯·å‡ºæ‹³ï¼';
      
      playButton.style.display = 'inline-block';
      resetButton.style.display = 'none';
      playButton.disabled = false;
    }
  </script>
</body>
</html>
